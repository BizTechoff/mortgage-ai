<div *ngIf="request" class="request-details-page">
    <main class="container">
        <div class="header-section">
            <button class="back-button" (click)="goBack()">
                <i class="fas fa-arrow-right"></i>
                חזרה
            </button>
            <h2>פרטי בקשה #{{ request.requestNumber }}</h2>
        </div>

        <div *ngIf="loading" class="loading-state">
            <span>טוען פרטי בקשה...</span>
            <div class="spinner"></div>
        </div>

        <div *ngIf="!loading && !request" class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>הבקשה לא נמצאה</h3>
            <p>לא ניתן למצוא בקשה עם המזהה שסופק.</p>
        </div>

        <div *ngIf="!loading && request" class="details-grid">
            <div class="card overview-card">
                <h3>סקירת בקשה</h3>
                <p>
                    <strong>לקוח:</strong>
                    {{ customer?.name || 'לא ידוע' }} ({{ customer?.mobile || 'לא ידוע' }})
                </p>
                <p>
                    <strong>סוג בקשה:</strong>
                    {{ request.requestType.caption || 'N/A' }}
                </p>
                <p>
                    <strong>סטטוס:</strong>
                    <span class="status-badge" [ngClass]="getStatusColorClass(request.status)">
                        {{ request.status.caption || 'N/A' }}
                    </span>
                </p>
                <p *ngIf="request.assignedOperator">
                    <strong>מפעיל משויך:</strong>
                    {{ request.assignedOperator.name || 'טרם שויך' }}
                </p>
                <p><strong>נוצר בתאריך:</strong> {{ request.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
                <p><strong>עודכן בתאריך:</strong> {{ request.updatedAt | date:'dd/MM/yyyy HH:mm' }}</p>

                <div class="action-buttons-group"
                    *ngIf="!isCustomer() && request.status.id !== RequestStatus.COMPLETED.id">
                    <button *ngIf="false" class="btn btn-primary" (click)="updateRequestStatus()">
                        <i class="fas fa-edit"></i> עדכון סטטוס
                    </button>
                    <button class="btn btn-secondary" (click)="assignRequest()" *ngIf="false">
                        <i class="fas fa-user-tag"></i> שיוך / העברה למתפעלת
                    </button>
                    <button class="btn btn-primary" (click)="startProcessing()"
                        *ngIf="request.status.id === RequestStatus.ASSIGNED.id">
                        <i class="fas fa-user-tag"></i> התחלת טיפול
                    </button>
                </div>
            </div>

            <div class="card stages-card">
                <h3>התקדמות ושלבי בקשה</h3>
                <div *ngIf="loadingStages" class="loading-inline">
                    טוען שלבים...
                </div>
                <div *ngIf="!loadingStages && stages.length === 0" class="empty-state-small">
                    <i class="fas fa-clipboard-list"></i>
                    <p>אין שלבים מוגדרים עבור סוג בקשה זה.</p>
                </div>
                <div class="stage-flow" *ngIf="!loadingStages && stages.length > 0">
                    <div class="stage-item" *ngFor="let currentStageItem of stages; let i = index"
                        [id]="'stage-item-' + currentStageItem.id"
                        [class.completed]="request.currentStageDetails && request.currentStageDetails.stage.id === currentStageItem.id && request.currentStageDetails.done"
                        [class.active]="request.currentStageDetails && request.currentStageDetails.stage.id === currentStageItem.id && !request.currentStageDetails.done">
                        <div class="stage-icon">
                            <i class="fas" [ngClass]="{
                'fa-check-circle': request.currentStageDetails?.stage?.id === currentStageItem.id && request.currentStageDetails?.done,
                'fa-circle': !(request.currentStageDetails?.stage?.id === currentStageItem.id && request.currentStageDetails?.done),
                'fa-arrow-alt-circle-right': request.currentStageDetails?.stage?.id === currentStageItem.id && !request.currentStageDetails?.done
            }"></i>
                        </div>
                        <div class="stage-content">
                            <h4>{{ currentStageItem.desc }}</h4>
                            <p *ngIf="currentStageItem.days">משך: {{ currentStageItem.days }} ימים</p>
                            <p *ngIf="isStageCompletedBeforeCurrent(currentStageItem)">
                                בפועל: הושלם
                            </p>
                            <ng-container *ngIf="request.currentStageDetails?.stage?.id === currentStageItem.id">
                                <p *ngIf="request.currentStageDetails?.started">התחלה: {{
                                    request.currentStageDetails?.started | date:'dd/MM/yyyy' }}</p>
                                <p *ngIf="request.currentStageDetails?.untill">יעד: {{
                                    request.currentStageDetails?.untill | date:'dd/MM/yyyy' }}</p>
                                <p *ngIf="request.currentStageDetails?.done">הושלם: {{ request.currentStageDetails?.done
                                    | date:'dd/MM/yyyy' }}</p>
                                <p *ngIf="request.currentStageDetails?.notes">הערות: {{
                                    request.currentStageDetails?.notes }}</p>
                            </ng-container>
                        </div>
                    </div>
                </div>
                <!-- {{request?.currentStageDetails? request?.currentStageDetails : 'NO'}} Debugging line to check current stage ID -->
                <div class="action-buttons-group"
                    *ngIf="!isCustomer() && request.status.id === RequestStatus.PROCESSING.id">
                    <button class="btn btn-secondary" (click)="promptUpdateStageProgress()">
                        <i class="fas fa-fast-forward"></i> עדכן התקדמות שלב
                    </button>
                </div>
            </div>

            <div class="card documents-card" *ngIf="request.requestType.id === RequestType.renew.id">
                <h3>מסמכים מצורפים</h3>
                <div *ngIf="loadingDocuments" class="loading-inline">
                    טוען מסמכים...
                </div>
                <div *ngIf="!loadingDocuments && documents.length === 0" class="empty-state-small">
                    <i class="fas fa-folder-open"></i>
                    <p>אין מסמכים מצורפים לבקשה זו.</p>
                </div>
                <ul class="document-list">
                    <li *ngFor="let doc of documents" class="document-item">
                        <a [href]="doc.id" download target="_blank">{{ doc.name }}</a>
                    </li>
                </ul>
            </div>

            <div class="card appointments-card">
                <h3>פגישות מתוכננות</h3>
                <div *ngIf="loadingAppointments" class="loading-inline">
                    טוען פגישות...
                </div>
                <div *ngIf="!loadingAppointments && !request.appointmentDetails" class="empty-state-small">
                    <i class="fas fa-calendar-times"></i>
                    <p>אין פגישות מתוכננות לבקשה זו.</p>
                </div>
                <ul class="appointment-list">

                    <div *ngIf="request.appointmentDetails?.date" class="personal-item"><strong>תאריך:</strong> {{
                        request.appointmentDetails?.date | date: 'dd/MM/yyyy' }}
                    </div>
                    <div *ngIf="request.appointmentDetails?.time" class="personal-item"><strong>שעה:</strong> {{
                        request.appointmentDetails?.time }}
                    </div>

                    <!-- <span>{{request.appointmentDetails}}</span>> -->
                    <!-- <li *ngFor="let appt of upcomingAppointments" class="appointment-item">
                        <i class="fas fa-calendar-check"></i>
                        <div>
                            <p><strong>תאריך:</strong> {{ appt.startDate | date:'dd/MM/yyyy HH:mm' }}</p>
                            <p *ngIf="appt.summary"><strong>סיכום:</strong> {{ appt.summary }}</p>
                        </div>
                    </li> -->
                </ul>
            </div>

            <!-- <div class="card questionnaire-card">
                <h3>נתוני שאלון (מערך תשובות)</h3>
                <div *ngIf="!request.questionnaireData || request.questionnaireData.answers.length === 0"
                    class="empty-state-small">
                    <i class="fas fa-clipboard-question"></i>
                    <p>אין נתוני שאלון (בפורמט תשובות) לבקשה זו.</p>
                </div>
                <div class="questionnaire-data-list" *ngIf="request.questionnaireData?.answers.length > 0">
                    <div *ngFor="let answer of request.questionnaireData?.answers" class="questionnaire-item">
                        <strong>{{ answer.questionText }}:</strong>
                        <span>{{ answer.answerText }}</span>
                    </div>
                </div>
            </div> -->

            <div class="card personal-details-card">
                <h3>פרטים אישיים</h3>
                <div *ngIf="!request.personalDetails" class="empty-state-small">
                    <i class="fas fa-user"></i>
                    <p>אין פרטים אישיים לבקשה זו.</p>
                </div>
                <div *ngIf="request.personalDetails" class="personal-data-list">
                    <div *ngIf="request.personalDetails.fullName" class="personal-item"><strong>שם מלא:</strong> {{
                        request.personalDetails.fullName }}</div>
                    <div *ngIf="request.personalDetails.mobile" class="personal-item"><strong>נייד:</strong> {{
                        request.personalDetails.mobile }}</div>
                    <div *ngIf="request.personalDetails.email" class="personal-item"><strong>דוא"ל:</strong> {{
                        request.personalDetails.email }}</div>
                    <!-- <div *ngIf="request.personalDetails.idNumber" class="personal-item"><strong>ת"ז:</strong> {{ request.personalDetails.idNumber }}</div> -->
                    <div *ngIf="request.personalDetails.address" class="personal-item"><strong>כתובת:</strong> {{
                        request.personalDetails.address }}
                    </div>
                </div>
            </div>

            <div *ngIf="request.requestType.id === RequestType.new.id" class="card demographic-details-card">
                <h3>מצב משפחתי ודמוגרפי</h3>
                <div *ngIf="!request.demographicDetails" class="empty-state-small">
                    <i class="fas fa-users"></i>
                    <p>אין פרטים דמוגרפיים לבקשה זו.</p>
                </div>
                <div *ngIf="request.demographicDetails" class="demographic-data-list">
                    <div *ngIf="request.demographicDetails.maritalStatus" class="demographic-item"><strong>מצב
                            משפחתי:</strong> {{
                        MaritalStatus.fromString(request.demographicDetails.maritalStatus).caption }}
                    </div>
                    <div *ngIf="request.demographicDetails.childrenDetails" class="demographic-item"><strong>ילדים
                            וגילם:</strong> {{ request.demographicDetails.childrenDetails }}
                    </div>
                    <div *ngIf="request.demographicDetails.husbandAge" class="demographic-item"><strong>גיל
                            הבעל:</strong> {{ request.demographicDetails.husbandAge }}
                    </div>
                    <div *ngIf="request.demographicDetails.wifeAge" class="demographic-item"><strong>גיל האישה:</strong>
                        {{ request.demographicDetails.wifeAge }}
                    </div>
                </div>
            </div>

            <div class="card key-financials-card">
                <h3>פרטים פיננסיים עיקריים</h3>
                <div *ngIf="!request.keyFinancials" class="empty-state-small">
                    <i class="fas fa-money-bill-alt"></i>
                    <p>אין פרטים פיננסיים עיקריים לבקשה זו.</p>
                </div>
                <div *ngIf="request.keyFinancials" class="key-financials-list">
                    <div *ngIf="request.keyFinancials.monthlyIncome" class="financial-item"><strong>הכנסה
                            חודשית:</strong> {{ request.keyFinancials.monthlyIncome | currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                    <div *ngIf="request.keyFinancials.partnerIncome" class="financial-item"><strong>הכנסת בן/בת
                            זוג:</strong> {{ request.keyFinancials.partnerIncome | currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                    <div *ngIf="request.keyFinancials.currentBank" class="financial-item"><strong>בנק נוכחי:</strong> {{
                        Bank.fromString(request.keyFinancials.currentBank).caption }}</div>
                </div>
            </div>

            <div *ngIf="request.requestType.id === RequestType.new.id" class="card employment-financials-card">
                <h3>תעסוקה ופיננסים משלימים</h3>
                <div *ngIf="!request.employmentAndOtherFinancials" class="empty-state-small">
                    <i class="fas fa-briefcase"></i>
                    <p>אין פרטים תעסוקתיים/פיננסיים משלימים לבקשה זו.</p>
                </div>
                <div *ngIf="request.employmentAndOtherFinancials" class="employment-financials-list">
                    <div *ngIf="request.employmentAndOtherFinancials.employmentType" class="financial-item">
                        <strong>עיסוק הבעל:</strong> {{
                        EmploymentType.fromString(request.employmentAndOtherFinancials.employmentType).caption }}
                    </div>
                    <div *ngIf="request.employmentAndOtherFinancials.wifeEmploymentType" class="financial-item">
                        <strong>עיסוק האישה:</strong> {{
                        EmploymentType.fromString(request.employmentAndOtherFinancials.wifeEmploymentType).female }}
                    </div>
                    <div *ngIf="request.employmentAndOtherFinancials.paymentReturns" class="financial-item"><strong>היו
                            החזרות צ'קים:</strong>
                        {{YesNo.fromString(request.employmentAndOtherFinancials.paymentReturns).caption }}
                    </div>
                    <div *ngIf="request.employmentAndOtherFinancials.healthIssues" class="financial-item"><strong>בעיות
                            בריאותיות:</strong> {{
                        YesNo.fromString(request.employmentAndOtherFinancials.healthIssues).caption }}
                    </div>
                    <div *ngIf="request.employmentAndOtherFinancials.hasLongTermLoans" class="financial-item">
                        <strong>הלוואות לטווח ארוך:</strong> {{
                        YesNo.fromString(request.employmentAndOtherFinancials.hasLongTermLoans).caption }}
                    </div>
                </div>
            </div>

            <div class="card property-details-card">
                <h3>פרטי נכס</h3>
                <div *ngIf="!request.propertyData" class="empty-state-small">
                    <i class="fas fa-home"></i>
                    <p>אין פרטי נכס לבקשה זו.</p>
                </div>
                <div *ngIf="request.propertyData" class="property-data-list">
                    <div *ngIf="request.propertyData.propertyCity" class="property-item"><strong>עיר הנכס:</strong> {{
                        request.propertyData.propertyCity }}
                    </div>
                    <div *ngIf="request.propertyData.propertyValue" class="property-item"><strong>שווי מוערך:</strong>
                        {{ request.propertyData.propertyValue | currency:'ILS':'symbol':'1.0-0' }}</div>
                    <div *ngIf="request.propertyData.numberOfRooms" class="property-item"><strong>מספר חדרים:</strong>
                        {{ request.propertyData.numberOfRooms }}
                    </div>
                    <div *ngIf="request.propertyData?.equityAmount" class="loan-item"><strong>הון עצמי:</strong> {{
                        request.propertyData.equityAmount | currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                    <div *ngIf="request.propertyData.hasAdditionalProperty" class="property-item"><strong>דירה
                            נוספת:</strong> {{ YesNo.fromString(request.propertyData.hasAdditionalProperty).caption }}
                    </div>
                </div>
            </div>

            <div class="card loan-details-card">
                <h3>פרטי הלוואה</h3>
                <div *ngIf="!request.loanData" class="empty-state-small">
                    <i class="fas fa-hand-holding-usd"></i>
                    <p>אין פרטי הלוואה לבקשה זו.</p>
                </div>
                <div *ngIf="request.loanData" class="loan-data-list">
                    <div *ngIf="request.loanData.loanAmount" class="loan-item"><strong>סכום מבוקש:</strong> {{
                        request.loanData.loanAmount | currency:'ILS':'symbol':'1.0-0' }}</div>
                    <div *ngIf="request.loanData.loanTerm" class="loan-item"><strong>תקופת הלוואה:</strong> {{
                        request.loanData.loanTerm }} שנים</div>
                </div>
            </div>

            <div class="card refinance-details-card"
                *ngIf="request.refinanceDetails && request.requestType.id === RequestType.renew.id">
                <h3>פרטי מחזור משכנתה</h3>
                <div *ngIf="!request.refinanceDetails" class="empty-state-small">
                    <i class="fas fa-exchange-alt"></i>
                    <p>אין פרטי מחזור לבקשה זו.</p>
                </div>
                <div *ngIf="request.refinanceDetails" class="refinance-data-list">
                    <div *ngIf="request.refinanceDetails.refinanceReason" class="refinance-item"><strong>סיבת
                            מחזור:</strong> {{ RenewReason.fromString(request.refinanceDetails.refinanceReason).caption
                        }}</div>
                    <div *ngIf="request.refinanceDetails.remainingMortgageBalance" class="refinance-item"><strong>יתרת
                            משכנתא:</strong> {{ request.refinanceDetails.remainingMortgageBalance |
                        currency:'ILS':'symbol':'1.0-0' }}</div>
                    <div *ngIf="request.refinanceDetails.currentMonthlyMortgagePayment" class="refinance-item">
                        <strong>תשלום חודשי למשכנתא:</strong> {{ request.refinanceDetails.currentMonthlyMortgagePayment
                        | currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                    <div *ngIf="request.refinanceDetails.hasOtherLoans" class="refinance-item"><strong>הלוואות
                            נוספות:</strong> {{ YesNo.fromString(request.refinanceDetails.hasOtherLoans).caption }}
                    </div>
                </div>
            </div>

            <div class="card other-loans-card"
                *ngIf="request.refinanceDetails?.hasOtherLoans === YesNo.yes.id && request.otherLoansDetails && request.requestType.id === RequestType.renew.id">
                <h3>הלוואות נוספות (פרטניות)</h3>
                <div *ngIf="!request.otherLoansDetails" class="empty-state-small">
                    <i class="fas fa-hand-holding-usd"></i>
                    <p>אין פרטי הלוואות נוספות לבקשה זו.</p>
                </div>
                <div *ngIf="request.otherLoansDetails" class="other-loans-data-list">
                    <div *ngIf="request.otherLoansDetails.otherLoansAmount" class="other-loan-item"><strong>גובה הלוואות
                            נוספות:</strong> {{ request.otherLoansDetails.otherLoansAmount |
                        currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                    <div *ngIf="request.otherLoansDetails.otherLoansMonthlyPayment" class="other-loan-item">
                        <strong>תשלום חודשי על הלוואות:</strong> {{ request.otherLoansDetails.otherLoansMonthlyPayment |
                        currency:'ILS':'symbol':'1.0-0' }}
                    </div>
                </div>
            </div>

            <div class="card goals-difficulties-card">
                <h3>מטרות וקשיים</h3>
                <div *ngIf="!request.goalsAndDifficulties" class="empty-state-small">
                    <i class="fas fa-bullseye"></i>
                    <p>אין פרטי מטרות וקשיים לבקשה זו.</p>
                </div>
                <div *ngIf="request.goalsAndDifficulties" class="goals-difficulties-list">
                    <div *ngIf="request.goalsAndDifficulties.desiredOutcome" class="goal-item"><strong>תוצאה
                            רצויה:</strong> {{ request.goalsAndDifficulties.desiredOutcome }}
                    </div>
                    <div *ngIf="request.goalsAndDifficulties.mainDifficulties" class="goal-item"><strong>קשיים
                            עיקריים:</strong> {{ request.goalsAndDifficulties.mainDifficulties }}
                    </div>
                    <div *ngIf="request.goalsAndDifficulties.optimalSituation" class="goal-item"><strong>מצב אופטימלי
                            עבורינו:</strong> {{ request.goalsAndDifficulties.optimalSituation }}
                    </div>
                    <div *ngIf="request.goalsAndDifficulties.paymentDifficultyRating" class="goal-item"><strong>קשיי
                            החזר:</strong> {{ request.goalsAndDifficulties.paymentDifficultyRating }}
                    </div>
                </div>
            </div>


            <div class="card internal-notes-card" *ngIf="!isCustomer()">
                <h3>הערות פנימיות</h3>
                <textarea [(ngModel)]="request.internalNotes" (blur)="saveInternalNotes()"
                    placeholder="הוסף הערות פנימיות לתיק..."></textarea>
            </div>

            <div class="card rejection-card" *ngIf="request.status.id === RequestStatus.REJECTED.id">
                <h3>סיבת דחייה</h3>
                <p>{{ request.rejectionReason || 'לא צוין.' }}</p>
            </div>
        </div>
    </main>
</div>