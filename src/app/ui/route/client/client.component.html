<div class="mortgage-app-container" dir="rtl">
    <header class="app-header">
        <div class="logo-container">
            <img src="./assets/logo.png" alt="לוגו של שירות המשכנתאות" class="logo">
            <h1 class="app-title">ניהול בקשות משכנתה</h1>
        </div>
    </header>
activeRequestId: {{this.activeRequestId}}
    <div class="content-wrapper">
        <main class="main-content">
            <div class="client-dashboard" *ngIf="!showWebForm">
                <h2>ברוך הבא למערכת ניהול המשכנתאות</h2>

                <div class="new-request-section" *ngIf="!activeRequest">
                    <h3>התחל בקשה חדשה</h3>
                    <div class="request-types">
                        <button class="request-type-btn" (click)="openNewRequest(RequestType.new)">
                            בקשת משכנתה חדשה
                        </button>
                        <button class="request-type-btn" (click)="openNewRequest(RequestType.renew)">
                            בקשת מחזור משכנתה
                        </button>
                    </div>
                </div>

                <div class="active-request-section" *ngIf="activeRequest">
                    <h3>בקשתך הפעילה:</h3>
                    <div class="request-details-card">
                        <p><strong>מספר בקשה:</strong> {{ activeRequest.requestNumber }}</p>
                        <p><strong>סוג בקשה:</strong>
                            {{ activeRequest.requestType === RequestType.new ? 'משכנתה חדשה' : 'מחזור משכנתה' }}</p>
                        <p><strong>סטטוס:</strong> {{ activeRequest.status.caption }}</p>
                        <p *ngIf="activeRequest.appointmentDetails">
                            <strong>פגישה קבועה:</strong> {{ activeRequest.appointmentDetails.date | date:'dd/MM/yyyy'
                            }} בשעה {{ activeRequest.appointmentDetails.time }}
                        </p>
                        <p><strong>שלב בקשה:</strong> {{ '' }}</p>
                        <p *ngIf="activeRequest.updatedAt">
                            <strong>עדכון אחרון:</strong> {{ activeRequest.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                        </p>
                        <button class="view-request-btn" (click)="viewActiveRequest()">
                            צפייה בפרטי הבקשה
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="web-form-container" *ngIf="showWebForm" (click)="$event.target === $event.currentTarget && closeForm()">
        <div *ngIf="!verificationStep && !formSubmitSuccess" (click)="$event.stopPropagation()">
            <form [formGroup]="mortgageForm" (ngSubmit)="submitForm()" class="mortgage-web-form">

                <div class="web-form-header">
                    <h2>{{ 'בקשת ' + requestType.caption + '' }}</h2>
                </div>

                <div class="form-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="formProgress"></div>
                    </div>
                    <div class="progress-text">שלב {{currentStep}} מתוך {{totalSteps}}</div>
                    <div style="color: red; font-size: 12px; text-align: center; margin-top: 5px;">
                        Debug: Step {{currentStep}}/{{totalSteps}} | Type: {{requestType.id}} | Valid:
                        {{isCurrentStepValid()}}
                    </div>
                </div>

                <div class="form-section" *ngIf="currentStep === 1">
                    <h3>פרטים אישיים ודמוגרפיים</h3>
                    <div class="form-group">
                        <label for="fullName">שם מלא *</label>
                        <input type="text" id="fullName" formControlName="fullName" placeholder="הזן שם מלא">
                        <div class="error-message" *ngIf="submitted && f['fullName'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group">
                        <label for="mobile" (click)="this.sendHiMessage()">נייד *</label>
                        <input type="tel" id="mobile" formControlName="mobile" placeholder="050-12345678"
                            [readOnly]="this.mobileValidated">
                        <div class="error-message" *ngIf="submitted && f['mobile'].errors">יש להזין נייד תקין
                        </div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="email">כתובת דואר אלקטרוני</label>
                        <input type="email" id="email" formControlName="email" placeholder="example@domain.com">
                        <div class="error-message" *ngIf="submitted && f['email'].errors">יש להזין כתובת דוא"ל תקינה
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="idNumber">מספר תעודת זהות *</label>
                        <input type="text" id="idNumber" formControlName="idNumber" placeholder="9 ספרות">
                        <div class="error-message" *ngIf="submitted && f['idNumber'].errors">מספר תעודת זהות לא תקין
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">כתובת מגורים *</label>
                        <input type="text" id="address" formControlName="address" placeholder="כתובת מלאה">
                        <div class="error-message" *ngIf="submitted && f['address'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="maritalStatus">מצב משפחתי</label>
                        <select id="maritalStatus" formControlName="maritalStatus">
                            <option value="">בחר</option>
                            <option value="married">נשוי/אה</option>
                            <option value="single">רווק/ה</option>
                            <option value="singleParent">הורה יחיד</option>
                            <option value="commonLaw">ידועים בציבור</option>
                            <option value="divorced">גרוש/ה</option>
                            <option value="other">אחר</option>
                        </select>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="childrenDetails">ילדים וגילם</label>
                        <input type="text" id="childrenDetails" formControlName="childrenDetails"
                            placeholder="לדוגמה: 2 (5, 10)">
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="husbandAge">גיל הבעל</label>
                        <input type="number" id="husbandAge" formControlName="husbandAge" placeholder="הזן גיל">
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="wifeAge">גיל האישה</label>
                        <input type="number" id="wifeAge" formControlName="wifeAge" placeholder="הזן גיל">
                    </div>
                </div>

                <div class="form-section" *ngIf="currentStep === 2">
                    <h3>פרטים פיננסיים ותעסוקתיים</h3>
                    <div class="form-group">
                        <label for="monthlyIncome">הכנסה חודשית (ברוטו) *</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="monthlyIncome" class="currency-input" formControlName="monthlyIncome"
                                (input)="onCurrencyInput($event, 'monthlyIncome')" placeholder="15,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                        <div class="error-message" *ngIf="submitted && f['monthlyIncome'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="partnerIncome">הכנסה חודשית של בן/בת הזוג</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="partnerIncome" class="currency-input" formControlName="partnerIncome"
                                (input)="onCurrencyInput($event, 'partnerIncome')" placeholder="10,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="employmentType">עיסוק הבעל *</label>
                        <select id="employmentType" formControlName="employmentType">
                            <option value="">בחר</option>
                            <option value="salaried">שכיר</option>
                            <option value="selfEmployed">עצמאי</option>
                            <option value="other">אחר</option>
                        </select>
                        <div class="error-message" *ngIf="submitted && f['employmentType']?.errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="wifeEmploymentType">עיסוק האישה</label>
                        <select id="wifeEmploymentType" formControlName="wifeEmploymentType">
                            <option value="">בחר</option>
                            <option value="salaried">שכירה</option>
                            <option value="selfEmployed">עצמאית</option>
                            <option value="other">אחר</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentBank">באיזה בנק מתנהל החשבון האישי *</label>
                        <select id="currentBank" formControlName="currentBank">
                            <option value="">בחר</option>
                            <option value="poalim">בנק הפועלים</option>
                            <option value="leumi">בנק לאומי</option>
                            <option value="mizrahi">בנק מזרחי טפחות</option>
                            <option value="discount">בנק דיסקונט</option>
                            <option value="hapoalim">בנק הבינלאומי</option>
                            <option value="other">אחר</option>
                        </select>
                        <div class="error-message" *ngIf="submitted && f['currentBank']?.errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="paymentReturns">האם היו החזרות של צ'קים או תשלומים בשלושת החודשים האחרונים?</label>
                        <select id="paymentReturns" formControlName="paymentReturns">
                            <option value="">בחר</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                            <option value="maybe">ייתכן</option>
                        </select>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="healthIssues">האם יש בעיות בריאותיות?</label>
                        <select id="healthIssues" formControlName="healthIssues">
                            <option value="">בחר</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                            <option value="maybe">ייתכן</option>
                        </select>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="hasLongTermLoans">האם יש הלוואות נוספות לתקופה של יותר מ-18 חודשים?</label>
                        <select id="hasLongTermLoans" formControlName="hasLongTermLoans">
                            <option value="">בחר</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                        </select>
                    </div>
                </div>

                <div class="form-section" *ngIf="currentStep === 3">
                    <h3>פרטי הנכס והלוואה</h3>
                    <div class="form-group" *ngIf="requestType === RequestType.renew">
                        <label for="propertyCity">באיזו עיר נמצא הנכס המדובר *</label>
                        <input type="text" id="propertyCity" formControlName="propertyCity" placeholder="הזן עיר">
                        <div class="error-message" *ngIf="submitted && f['propertyCity']?.errors">שדה חובה</div>
                    </div>
                    <div class="form-group">
                        <label for="propertyValue">שווי הנכס המוערך *</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="propertyValue" class="currency-input" formControlName="propertyValue"
                                (input)="onCurrencyInput($event, 'propertyValue')" placeholder="1,500,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                        <div class="error-message" *ngIf="submitted && f['propertyValue'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="equityAmount">כמה כסף יש כהון עצמי?</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="equityAmount" class="currency-input" formControlName="equityAmount"
                                (input)="onCurrencyInput($event, 'equityAmount')" placeholder="300,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loanAmount">סכום ההלוואה המבוקש *</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="loanAmount" class="currency-input" formControlName="loanAmount"
                                (input)="onCurrencyInput($event, 'loanAmount')" placeholder="1,200,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                        <div class="error-message" *ngIf="submitted && f['loanAmount'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group">
                        <label for="loanTerm">תקופת ההלוואה (בשנים) *</label>
                        <select id="loanTerm" formControlName="loanTerm">
                            <option value="">בחר</option>
                            <option value="10">10 שנים</option>
                            <option value="15">15 שנים</option>
                            <option value="20">20 שנים</option>
                            <option value="25">25 שנים</option>
                            <option value="30">30 שנים</option>
                        </select>
                        <div class="error-message" *ngIf="submitted && f['loanTerm'].errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.renew">
                        <label for="refinanceReason">סיבת המחזור *</label>
                        <select id="refinanceReason" formControlName="refinanceReason">
                            <option value="">בחר</option>
                            <option value="lowerRate">הורדת ריבית</option>
                            <option value="lowerPayment">הקטנת תשלום חודשי</option>
                            <option value="additionalMoney">משיכת כספים נוספים</option>
                            <option value="trackChange">שינוי מסלול</option>
                            <option value="other">אחר</option>
                        </select>
                        <div class="error-message" *ngIf="submitted && f['refinanceReason']?.errors">שדה חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.renew">
                        <label for="remainingMortgageBalance">מהי יתרת המשכנתא למיטב ידיעתך *</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="remainingMortgageBalance" class="currency-input"
                                formControlName="remainingMortgageBalance"
                                (input)="onCurrencyInput($event, 'remainingMortgageBalance')" placeholder="800,000">
                            <span class="currency-symbol">₪</span>
                        </div>
                        <div class="error-message" *ngIf="submitted && f['remainingMortgageBalance']?.errors">שדה חובה
                        </div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.renew">
                        <label for="currentMonthlyMortgagePayment">מה התשלום החודשי שלך בגין המשכנתא *</label>
                        <div class="currency-input-wrapper">
                            <input type="text" id="currentMonthlyMortgagePayment" class="currency-input"
                                formControlName="currentMonthlyMortgagePayment"
                                (input)="onCurrencyInput($event, 'currentMonthlyMortgagePayment')" placeholder="4,500">
                            <span class="currency-symbol">₪</span>
                        </div>
                        <div class="error-message" *ngIf="submitted && f['currentMonthlyMortgagePayment']?.errors">שדה
                            חובה</div>
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.renew">
                        <label for="hasOtherLoans">האם יש הלוואות נוספות מעבר למשכנתא?</label>
                        <select id="hasOtherLoans" formControlName="hasOtherLoans">
                            <option value="">בחר</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                        </select>
                    </div>
                    <ng-container
                        *ngIf="requestType === RequestType.renew && mortgageForm.get('hasOtherLoans')?.value === 'yes'">
                        <div class="form-group">
                            <label for="otherLoansAmount">מה גובה ההלוואות הנוספות מעבר למשכנתא *</label>
                            <div class="currency-input-wrapper">
                                <input type="text" id="otherLoansAmount" class="currency-input"
                                    formControlName="otherLoansAmount"
                                    (input)="onCurrencyInput($event, 'otherLoansAmount')" placeholder="100,000">
                                <span class="currency-symbol">₪</span>
                            </div>
                            <div class="error-message" *ngIf="submitted && f['otherLoansAmount']?.errors">שדה חובה
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="otherLoansMonthlyPayment">מה התשלום החודשי על ההלוואות מעבר למשכנתא *</label>
                            <div class="currency-input-wrapper">
                                <input type="text" id="otherLoansMonthlyPayment" class="currency-input"
                                    formControlName="otherLoansMonthlyPayment"
                                    (input)="onCurrencyInput($event, 'otherLoansMonthlyPayment')" placeholder="1,500">
                                <span class="currency-symbol">₪</span>
                            </div>
                            <div class="error-message" *ngIf="submitted && f['otherLoansMonthlyPayment']?.errors">שדה
                                חובה</div>
                        </div>
                    </ng-container>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="numberOfRooms">מספר חדרים</label>
                        <input type="number" id="numberOfRooms" formControlName="numberOfRooms"
                            placeholder="הזן מספר חדרים">
                    </div>
                    <div class="form-group" *ngIf="requestType === RequestType.new">
                        <label for="hasAdditionalProperty">האם יש דירה נוספת?</label>
                        <select id="hasAdditionalProperty" formControlName="hasAdditionalProperty">
                            <option value="">בחר</option>
                            <option value="yes">כן</option>
                            <option value="no">לא</option>
                            <option value="maybe">ייתכן</option>
                        </select>
                    </div>
                </div>

                <div class="form-section" *ngIf="currentStep === 4">
                    <ng-container *ngIf="requestType === RequestType.new">
                        <h3>מטרות ופגישה</h3>
                        <div class="form-group">
                            <label for="desiredOutcome">מה התוצאה שאתם מעוניינים להשיג?</label>
                            <textarea id="desiredOutcome" formControlName="desiredOutcome"
                                placeholder="לדוגמה: להקטין את ההחזר החודשי, לקבל הלוואה נוספת..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="mainDifficulties">מהם הקשיים העיקריים בקבלת משכנתא חדשה?</label>
                            <textarea id="mainDifficulties" formControlName="mainDifficulties"
                                placeholder="לדוגמה: חוסר הון עצמי, קושי באישור בבנק..."></textarea>
                        </div>
                        <h4>בחירת מועד פגישה</h4>
                        <p class="appointment-info">בחר מועד מתאים לפגישת ייעוץ:</p>
                        <div class="appointment-slots">
                            <div class="appointment-slot" *ngFor="let slot of availableSlots; let i = index"
                                [class.selected]="selectedAppointment === i" (click)="selectAppointment(i)">
                                <div class="slot-date">{{slot.date | date:'EEEE, dd/MM/yyyy' }}</div>
                                <div class="slot-time">{{slot.time}}</div>
                            </div>
                        </div>
                        <div class="error-message" *ngIf="appointmentError">יש לבחור מועד לפגישה</div>
                    </ng-container>

                    <ng-container *ngIf="requestType === RequestType.renew">
                        <h3>העלאת מסמכים</h3>
                        <p class="upload-info">יש להעלות את המסמכים הבאים:</p>
                        <div class="document-upload-list">
                            <div class="document-upload-item">
                                <label for="idDocument">תעודת זהות (כולל ספח) *</label>
                                <input type="file" id="idDocument" (change)="onFileSelected($event, 'idDocument')"
                                    accept=".jpg,.jpeg,.png,.pdf">
                            </div>
                            <div class="document-upload-item">
                                <label for="salarySlips">3 תלושי שכר אחרונים *</label>
                                <input type="file" id="salarySlips" (change)="onFileSelected($event, 'salarySlips')"
                                    accept=".jpg,.jpeg,.png,.pdf">
                            </div>
                            <div class="document-upload-item">
                                <label for="bankStatements">3 דפי חשבון בנק אחרונים *</label>
                                <input type="file" id="bankStatements"
                                    (change)="onFileSelected($event, 'bankStatements')" accept=".jpg,.jpeg,.png,.pdf">
                            </div>
                            <div class="document-upload-item">
                                <label for="propertyDoc">מסמכי הנכס (טאבו/חוזה) *</label>
                                <input type="file" id="propertyDoc" (change)="onFileSelected($event, 'propertyDoc')"
                                    accept=".jpg,.jpeg,.png,.pdf">
                            </div>
                            <div class="document-upload-item">
                                <label for="mortgageStatement">דו"ח יתרות משכנתה נוכחית *</label>
                                <input type="file" id="mortgageStatement"
                                    (change)="onFileSelected($event, 'mortgageStatement')"
                                    accept=".jpg,.jpeg,.png,.pdf">
                                <p class="upload-note">ניתן להוריד מהאזור האישי באתר הבנק </p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="paymentDifficultyRating">עד כמה היום אתם מתקשים לשלם את התשלום החודשי של המשכנתא
                                וההלוואות?</label>
                            <input type="range" id="paymentDifficultyRating" formControlName="paymentDifficultyRating"
                                min="1" max="10">
                            <span class="range-value">{{ mortgageForm.get('paymentDifficultyRating')?.value }}</span>
                            (1=לא מתקשה כלל, 10=מתקשה מאוד)
                        </div>
                        <div class="form-group">
                            <label for="optimalSituation">איך היית מגדיר את המצב האופטימלי עבורך</label>
                            <textarea id="optimalSituation" formControlName="optimalSituation"
                                placeholder="לדוגמה: תשלום חודשי X, קיצור תקופה Y..."></textarea>
                        </div>
                    </ng-container>
                </div>

                <div class="form-section" *ngIf="currentStep === 5 && requestType === RequestType.renew">
                    <h3>בחירת מועד פגישה</h3>
                    <p class="appointment-info">בחר מועד מתאים לפגישת ייעוץ:</p>
                    <div class="appointment-slots">
                        <div class="appointment-slot" *ngFor="let slot of availableSlots; let i = index"
                            [class.selected]="selectedAppointment === i" (click)="selectAppointment(i)">
                            <div class="slot-date">{{slot.date | date:'EEEE, dd/MM/yyyy' }}</div>
                            <div class="slot-time">{{slot.time}}</div>
                        </div>
                    </div>
                    <div class="error-message" *ngIf="appointmentError">יש לבחור מועד לפגישה</div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="prev-btn" *ngIf="currentStep > 1" (click)="prevStep()"
                        style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                        הקודם
                    </button>

                    <button type="button" class="next-btn" *ngIf="currentStep < totalSteps" (click)="nextStep()"
                        style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                        <span>הבא</span>
                        <span style="color: white; font-size: 10px; margin-right: 5px;">
                            <span>[{{currentStep}}&lt;{{totalSteps}}]</span>
                        </span>
                    </button>

                    <button type="submit" class="submit-btn" *ngIf="currentStep === totalSteps"
                        style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                        שלח בקשה
                    </button>
                </div>
            </form>
        </div>

        <div class="success-message" *ngIf="formSubmitSuccess" (click)="$event.stopPropagation()">
            <div class="success-icon">✓</div>
            <h3>בקשתך נשלחה בהצלחה!</h3>
            <p>תודה שפנית אלינו. מספר הבקשה שלך: <strong>{{requestNumber}}</strong></p>
            <p>נציג יצור איתך קשר בהקדם.</p>
            <p *ngIf="appointmentDetails">
                נקבעה פגישה בתאריך: <strong>{{appointmentDetails.date | date:'dd/MM/yyyy'}} בשעה
                    {{appointmentDetails.time}}</strong>
            </p>
            <button class="close-btn" (click)="closeForm()">סגור</button>
        </div>
    </div>

    <footer class="app-footer">
        <div class="footer-content">
            <p>&copy; 2025 מערכת ניהול משכנתאות. כל הזכויות שמורות.</p>
        </div>
    </footer>
</div>